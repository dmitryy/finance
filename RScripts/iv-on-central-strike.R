# 2019 Jan, Feb, Mar SiH9 
asset = c(69545,68473,67691,67622,67788,67600,67603,67488,67082,67226,66812,66928,67029,66697,66274,66487,66629,66491,66494,65844,66056,66082,65990,66230,66279,66035,66183,66004,66081,67410,66884,66419,66293,65880,65716,65660,65608,66070,66086,66082,65936,65867,65952,66150,66232,66095,65746,65500,65590,65246,64491,64423,64308,63733)
callStrikes = c(69500,68500,67500,67500,67750,67500,67500,67500,67000,67250,66500,67000,67000,66750,66000,66500,66750,66500,66500,65750,66000,66000,66000,66000,66000,66000,66250,66000,66000,67500,67000,66500,66000,66000,65750,65750,65500,66000,66000,66000,66000,65750,66000,66250,66250,66000,65750,65500,65500,65250,64500,64500,64250,63750)
callPrices = c(1880,1648,1657,1577,1585,1670,1571,1501,1436,1483,1445,1280,1330,1262,1232,1210,1100,1123,1072,1034,1015,997,890,1125,1099,990,803,897,884,945,849,824,1000,749,750,730,735,700,700,670,543,600,561,550,551,500,450,370,360,352,255,165,179,2)
putStrikes = c(69500,68500,67500,67500,67500,67500,67500,67500,67000,67250,66500,67000,67000,66500,66250,66500,66500,66500,66500,65750,66000,66000,66000,66000,66000,66000,66000,66000,66000,67500,67000,66500,66000,66000,65750,65750,65500,66000,66000,66000,66000,65750,66000,66000,66000,66000,65750,65500,65500,65250,64500,64500,64250,63750)
putPrices = c(1850,1721,1550,1654,1367,1470,1372,1430,1366,1372,1200,1376,1282,1110,1040,1213,1075,1073,1075,1000,989,907,960,814,814,952,855,902,870,1143,951,900,694,861,800,779,648,632,615,565,602,469,585,488,431,403,407,370,284,284,250,254,127,35)
# 2019 Apr, May, Jun SiM9
asset = c(66726,66666,66739,66921,67026,66900,66563,66312,66395,66054,65325,65255,65132,64608,65535,64853,65132,65720,65865,66480,66139,66203,65852,66190,65933,65666,65547,64985,65249,64924,64911,64839,64520,64542,64639,64354,64311,64798,65278,65245,64965,65000,65949,65510,65670,65679,65351,65632,65795,65331,64842,64813,65008,64782,64701,64580,64941,64740,64645,64864,65380,65318,65375,65454,65355,65451,65217,64969,64821,64613,64576,64387,64285,64034,63846,63252,0)
callStrikes = c(66500,66500,67000,67000,67000,67000,66500,66000,66500,66000,65250,65250,65250,64500,65500,64500,65250,65750,65750,66500,66250,66250,65500,66000,66000,65750,65500,65000,65250,65000,65000,64750,64500,64500,64500,64250,64250,64750,65250,65000,65000,65000,66000,65500,65750,65750,65250,65750,65750,65250,64750,64750,65000,64750,64750,64500,65000,64750,64750,64500,65500,65250,65500,65500,65250,65500,65250,65000,64750,64500,64500,64500,64250,64000,63750,63250,0)
callPrices = c(1670,1780,1566,1600,1535,1589,1597,1600,1450,1442,1357,1400,1300,1409,1366,1600,1500,1400,1480,1485,1460,1400,1670,1446,1360,1610,1310,1198,1120,1124,1116,1147,1139,1083,1117,1057,1037,963,1050,1189,980,986,947,951,950,900,1075,900,939,1036,920,750,739,670,614,651,625,820,578,740,511,697,488,575,500,426,430,408,407,425,338,195,200,207,222,5,0)
putStrikes = c(66750,66750,66500,67000,67000,67000,66500,66000,66500,66000,65250,65250,65250,64500,65500,64500,65250,65500,65750,66500,66000,66000,65750,66000,66000,65750,65500,65000,65000,65000,65000,64500,64500,64500,64500,64000,64250,64500,65000,65000,65000,65000,66000,65500,65750,65500,65000,65500,65500,65000,64500,64500,65000,64750,64750,64500,65000,64750,64750,64750,65500,65250,65500,65500,65250,65500,65250,65000,64750,64500,64500,64500,64250,64000,63750,63250,0)
putPrices = c(1700,1425,1440,1827,1815,1655,1510,1313,1550,1394,1390,1390,1200,1254,1311,1146,1549,1280,1295,1496,1345,1305,1327,1290,1400,1328,1202,1212,1096,1252,1170,830,1079,1026,1015,802,1010,862,876,864,1011,1000,1043,946,1033,819,722,827,721,605,555,571,710,549,686,566,695,502,613,500,625,574,646,548,400,485,310,450,325,290,263,320,210,176,85,1,0)
# 2019 Jul, Aug, Sep SiU9
asset = c(66311,66190,66286,66066,65787,65658,65433,65398,65200,65098,64858,64660,63800,64112,63565,63621,63848,63862,63839,63622,64039,64168,64110,64475,64144,64381,63763,63453,63616,63165,63359,63334,63646,63511,63539,63746,63576,63657,63888,63938,64099,63904,64260,65633,65461,65695,65943,65481,65821,65846,65385,66226,66496,66740,67096,66841,66075,65938,66270,66220,66739,66782,66705,66934,66875,67177,66240,66239,65824,65578,65430,65593,64928,64254,64001,64346,64220,64171,0)
callStrikes = c(66000,66250,66250,66000,65500,65500,65500,65500,65000,65000,64500,64750,63500,64000,63500,63500,63500,63750,63750,63500,64000,64250,64000,64500,64250,64500,63750,63500,63500,63250,63000,63250,63500,63500,63500,63750,63500,63750,64000,64000,64000,64000,64000,65750,65500,65750,66000,65500,65750,65750,65500,66250,66500,66750,67000,66750,66000,66000,66250,66250,66750,66750,66750,67000,67000,67250,66250,66250,65750,65500,65500,65500,65000,64250,64000,64250,64250,64250,0)
callPrices = c(1540,1366,1453,1400,1596,1350,1222,1350,1400,1260,1657,1330,1420,1185,1130,1170,1270,1077,1057,1092,1043,1010,1070,940,900,972,1249,927,995,857,1070,917,984,880,872,740,857,803,825,810,900,751,946,800,894,884,847,900,828,924,716,685,905,839,870,837,805,701,709,714,593,721,711,625,550,573,523,500,500,467,357,461,319,428,274,330,188,1,0)
putStrikes = c(66000,66000,66000,66000,65750,65500,65750,65500,65000,65000,65000,64500,63500,64000,63500,63500,63750,63750,63500,63500,64000,64000,64000,64500,64000,64500,63500,63500,63500,63000,63000,63250,63500,63500,63500,63500,63500,63500,64000,64000,64000,64000,64000,65500,65500,65500,66000,65500,65750,65750,65500,66000,66500,66750,67000,66500,66000,66000,66250,66250,66500,66750,66750,67000,67000,67250,66250,66250,65750,65500,65500,65500,65000,64250,64000,64250,64250,64250,0)
putPrices = c(1100,1300,1320,1300,1280,1168,0,1270,1230,1300,1300,1109,1000,1075,1011,1000,1081,1049,965,980,1000,923,911,1012,879,1015,780,964,820,850,723,865,816,870,871,759,769,799,951,876,769,863,641,869,926,951,900,890,930,888,825,845,878,921,812,600,688,757,756,716,584,700,673,677,670,623,662,580,499,386,407,321,390,276,275,222,250,100,0)
# 2019 Oct, Nov, Dec SiZ9
asset = c(67697,67985,67043,66987,66604,66336,66226,66394,65700,65030,64768,65131,64983,64651,64734,64580,64607,64950,64951,65184,65581,66060,65915,65880,65266,65504,65947,65464,65030,64670,64883,64782,64713,64521,64498,64232,64075,64310,64583,64090,64181,64271,64475,64499,63802,64005,64176,64081,64121,64188,64432,64605,64352,64044,64086,64083,64144,63963,64013,64179,64241,64210,64261,64455,64341,64355,64025,63966,63767,63759,63582,63677,62785,62891,62451,62506,62553,62420)
callStrikes = c(67750,68000,67000,67000,66500,66250,66500,66500,65500,65000,64750,65000,65000,64750,64500,64500,64500,65000,65000,65000,65500,66000,66000,66000,65250,65500,66000,65500,65000,64500,65000,64500,64500,64500,64500,64250,64000,64000,64500,64000,64250,64250,64500,64500,63500,64000,64250,64000,64000,64250,64500,64500,64250,64000,64000,64000,64250,64000,64000,64250,64250,64250,64250,64500,64250,64250,64000,64000,63750,63750,63500,63750,62750,63000,62500,62500,62500,62500)
callPrices = c(1680,1600,1600,1500,1532,1480,1331,1300,1650,1391,1300,1380,1300,1350,1409,1365,1255,1205,1205,1295,1220,1214,1217,1167,1200,1122,1096,1140,1100,1106,1004,1180,1128,1004,1021,977,959,1072,963,900,850,900,827,770,1380,775,723,773,788,700,673,735,640,637,635,611,595,521,502,430,509,435,480,400,520,352,385,336,335,327,340,250,250,204,153,181,171,1)
putStrikes = c(68000,67750,67000,67000,66500,66000,66250,66250,65750,65000,64500,65000,65000,64750,64750,64500,64500,65000,65000,65000,65500,66000,66000,66000,65000,65500,66000,65500,65000,64750,65000,64500,64750,64500,64500,64250,64000,64250,64500,64000,64250,64250,64500,64500,63500,64000,64250,64000,64000,64250,64500,64500,64250,64000,64000,64000,64000,64000,64000,64250,64250,64250,64250,64500,64250,64250,64000,64000,63750,63750,63500,63500,62750,63000,62500,62500,62500,62500)
putPrices = c(0,1440,1367,1580,1167,1240,1350,1440,1193,1287,1072,1200,1300,1380,1427,1200,1173,1237,1218,1075,1124,1180,1270,1282,1010,1124,1191,1148,1060,1130,1137,889,1014,1015,991,970,919,952,886,817,900,815,861,825,640,742,829,700,648,760,730,640,532,613,541,536,502,552,494,510,510,546,390,450,304,307,345,348,307,340,263,207,250,290,224,183,103,75)

# BS d1
d1 <- function (S, E, r, volatility, expiry) {
  (log(S / E) + (r + 0.5 * volatility ^ 2) * (expiry)) / (volatility * sqrt(expiry))
}

# BS d2
d2 <- function (d1, volatility, expiry) {
  d1 - volatility * sqrt(expiry)
}

# call
C <- function (S, d1, d2, E, r, expiry) {
  S * pnorm(d1) - E * exp(-r * (expiry)) * pnorm(d2)
}

# put
P <- function (S, d1, d2, E, r, expiry) {
  -S * pnorm(-d1) + E * exp(-r * (expiry)) * pnorm(-d2)
}

Vega <- function (S, d1, expiry) {
  S * sqrt(expiry / pi / 2) * exp(-0.5 * d1 ^ 2)
}

# IV Call
IvCall <- function (C, E, expiry, S, r, error) {
  sigma = 1
  dv = error + 1
  while (!is.na(dv) && abs(dv) > error) {
    d1 = d1(S, E, r, sigma, expiry)
    d2 = d2(d1, sigma, expiry)
    CallPrice = C(S, d1, d2, E, r, expiry)
    Vega = Vega(S, d1, expiry)
    PriceError = CallPrice - C
    dv = PriceError / Vega
    sigma = sigma - dv
  }
  sigma
}

# IV Put
IvPut <- function (P, E, expiry, S, r, error) {
  sigma = 1
  dv = error + 1
  while (!is.na(dv) && abs(dv) > error) {
    d1 = d1(S, E, r, sigma, expiry)
    d2 = d2(d1, sigma, expiry)
    PutPrice = P(S, d1, d2, E, r, expiry)
    Vega = Vega(S, d1, expiry)
    PriceError = PutPrice - P
    dv = PriceError / Vega
    sigma = sigma - dv
  }
  sigma
}

n = length(asset)
ivCall = array(n)
ivPut = array(n)
rate = 0
error = 0.001

for (i in 1:(n-1)) {
  expiry = 1 / 252 * (n - (i - 1))
  ivCall[i] = IvCall(callPrices[i], callStrikes[i], expiry, asset[i], rate, error)
  ivPut[i] = IvPut(putPrices[i], putStrikes[i], expiry, asset[i], rate, error)
}

xrange = range(0, n-1)
yrange = range(0, ivPut, ivCall)

plot(xrange, yrange, type = "n", xlab = "Day", ylab = "Volatility")
#plot(asset, type="l")
points(1:(n-1), ivCall, col = "red3", type = "o")
points(1:(n-1), ivPut, col = "forestgreen", type = "o")


